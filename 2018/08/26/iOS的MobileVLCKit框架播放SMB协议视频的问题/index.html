<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS的MobileVLCKit框架播放SMB协议视频的问题 · Jim Huang的博客</title><meta name="description" content="iOS的MobileVLCKit框架播放SMB协议视频的问题 - Jim Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/sunsx9316/atom.xml" title="Jim Huang的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sunsx9316" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS的MobileVLCKit框架播放SMB协议视频的问题</h1><div class="post-info">Aug 26, 2018</div><div class="post-content"><p><a href="https://code.videolan.org/videolan/VLCKit" target="_blank" rel="noopener">MobileVLCKit</a>是开源播放器VLC的iOS平台框架，在Mac OS上也有对应的VLCKit，搞直播的同学应该不陌生，不过它其实还是一款强大的本地播放器，支持几乎所有的主流媒体格式。最近在研究app如何浏览电脑上文件，然后直接做到播放视频的功能。用过iOS上的VLC播放器的童鞋应该知道，他能做到扫描本地端口，然后通过输入用户名和密码浏览电脑的文件，点击视频和音频还能直接播放。<br>通过Google知道这里用到一个叫SMB的协议，不光是Mac OS上，Windows和Linux都支持这种协议。只要本地开启SMB的文件共享服务，同一个局域网内的设备就能通过它访问电脑上的文件了。<br>上上<del>gayhub</del>发现了一个SMB的iOS框架，叫<a href="https://github.com/TimOliver/TOSMBClient">TOSMBClient</a>，它将一个C语言的框架封装成了OC的框架。还支持CocoaPods，使用起来非常方便。而<a href="https://code.videolan.org/videolan/VLCKit" target="_blank" rel="noopener">MobileVLCKit</a>原生就支持SMB协议的在线播放。所以解决方案是通过TOSMBClient获取文件列表，VLC播放，想法很美好，但是实际实现还是踩了不少坑。</p>
<p>先说说SMB的格式，长这样：<code>smb://{hostname}:{password}@{ip}/path</code> 比如桌面上的一个mp4文件就应该长这样：<code>smb://xiaoming:123456@192.168.1.100/xiaoming/Desktop/233.mp4</code><br>hostname是域名，一般创建SMB共享协议的时候，就需要指定。password是密码，ip是服务器的ip。<br><a href="https://github.com/TimOliver/TOSMBClient">TOSMBClient</a>提供了一个登录的类叫<code>TOSMBSession</code>，常用属性是这几个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//服务器域名</span><br><span class="line">@property (nonatomic, copy) NSString *hostName;</span><br><span class="line">//服务器ip</span><br><span class="line">@property (nonatomic, copy) NSString *ipAddress;</span><br><span class="line">//登录的用户名</span><br><span class="line">@property (nonatomic, copy) NSString *userName;</span><br><span class="line">//登录密码</span><br><span class="line">@property (nonatomic, copy) NSString *password;</span><br></pre></td></tr></table></figure></p>
<p>其中域名和ip可以都设置，也可以只设置其中一个，框架会自动查找。<br>然后通过<code>TOSMBSession</code>提供的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)requestContentsOfDirectoryAtFilePath:(NSString *)path</span><br><span class="line">success:(void (^)(NSArray *files))successHandler</span><br><span class="line"> error:(void (^)(NSError *))errorHandler;</span><br></pre></td></tr></table></figure></p>
<p>获取文件列表，很简单。返回的files是<code>TOSMBSessionFile</code>类型。它包含基本的文件信息，比如路径，名称，大小。想法挺美好，有URL，直接给VLC播放不就行了，然后就碰到了<strong>第一个坑。</strong><br><code>TOSMBSessionFile</code>提供的路径只是smb格式的一部分，也就只有path部分，所以需要播放还得自己拼接成完整路径。</p>
<p>拼接好了之后尝试下播放个文件，没带中文的，成功了，高兴之余本着严谨的态度试了下中文路径，结果失败了。NSURL初始化如果包含标准ASCALL以外的字符，会返回nil，这是<strong>第二个坑。</strong></p>
<p>作为程序员，很自然会想到，URL如果带中文，浏览器会自动做URL转码。所以尝试下转码，发现还是播放失败。这就让我怀疑人生了，怎么肥事？而且连iOS上的VLC的app都有这个问题，这是<strong>第三个坑。</strong></p>
<p>通过查找API我发现播放器除了通过NSURL初始化，还可以通过NSString初始化，我想，NSURL不让包含中文，NSString总可以吧。结果还是播放失败，神奇的是即使不包含中文，通过NSString初始化还是失败，但是NSURL就可以，这是<strong>第四个坑。</strong></p>
<p>既然一定要实现功能，那就得搞明白为什么，这时候开源的好处就体现出来了，我看了下<a href="https://code.videolan.org/videolan/VLCKit" target="_blank" rel="noopener">MobileVLCKit</a>的源码，它的媒体类<strong>VLCMedia</strong>是这么写的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithPath:(NSString *)aPath</span><br><span class="line">&#123;</span><br><span class="line">    return [self initWithURL:[NSURL fileURLWithPath:aPath isDirectory:NO]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithURL:(NSURL *)anURL</span><br><span class="line">&#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        const char *url;</span><br><span class="line">        VLCLibrary *library = [VLCLibrary sharedLibrary];</span><br><span class="line">        NSAssert(library.instance, @&quot;no library instance when creating media&quot;);</span><br><span class="line"></span><br><span class="line">        if (([[anURL absoluteString] hasPrefix:@&quot;sftp://&quot;]) ||</span><br><span class="line">            ([[anURL absoluteString] hasPrefix:@&quot;smb://&quot;])) &#123;</span><br><span class="line">            url = [[[anURL absoluteString] stringByRemovingPercentEncoding] UTF8String];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            url = [[anURL absoluteString] UTF8String];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p_md = libvlc_media_new_location(library.instance, url);</span><br><span class="line"></span><br><span class="line">        _metaDictionary = [[NSMutableDictionary alloc] initWithCapacity:3];</span><br><span class="line"></span><br><span class="line">        [self initInternalMediaDescriptor];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，<code>initWithPath:</code>方法把字符串通过<code>fileURLWithPath:isDirectory:</code>方法初始化成URL了，所以smb格式的字符串路径通过这个方法初始化得到的路径肯定是错的，因为它不是标准的本地路径，自然会出现上面神奇的情况。<br>然后看下<code>initWithURL:</code>方法，if语句判断如果包含smb前缀，则做URL解码操作。说明我们的想法是正确的，确实应该对URL进行编码。但是，经过测试编码还是不行，这种情况就很费解了。到现在我还不知道什么原因，因为它自己的APP都有这个问题。不过之后偶然发现了解决方法，很简单<br><strong><br>把URL编码两次即可！！<br>把URL编码两次即可！！<br>把URL编码两次即可！！
</strong></p>
<p>重要的事情说三遍，编码两次之后框架会对URL解码一次，所以得到的URL实际是编码了一次的内容，这样就能播放了，非常神奇，这是<strong>第五个坑。</strong>在这里分享一下给需要的童鞋。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>应该只对<code>path</code>、<code>hostname</code>、<code>password</code>部分做URL两次编码，<code>smb://</code>前缀不需要，否则播放器会无法识别。</p>
<p>2017.10.16日更新 如果发现拼接之后还是没法播放，大部分是因为VLC的版本比较旧的关系，cocoapods里有最新的unstable版本，用这个，不过这个版本也是最不稳定的。</p>
<p>2018.7.8日更新 <a href="https://github.com/sunsx9316/SMBPlayerDemo">文章Demo</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/12/15/对于订阅和反订阅的一些思考/" class="prev">上一篇</a><a href="/2018/08/26/APP切换主题的一些思考/" class="next">下一篇</a></div><div class="copyright"><p>© 2018 <a href="https://github.com/sunsx9316">Jim Huang</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>